<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JPEG Frame Uploader (640x480 @ 24fps)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    .row { display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; }
    video, canvas { width: 320px; height: 240px; background:#000; }
    button { padding:8px 14px; border:1px solid #aaa; border-radius:8px; cursor:pointer; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#e8eefc; border:1px solid #cad6ff; margin-left:8px; }
    #log { white-space: pre-wrap; background:#f7f7f7; padding:8px; border:1px solid #ddd; border-radius:8px; margin-top:12px; max-height:220px; overflow:auto; }
    label { display:block; margin-top:8px; }
    input[type=range] { width:220px; vertical-align:middle; }
  </style>
</head>
<body>
  <h2>ë¸Œë¼ìš°ì € â†’ Flask (JPEG í”„ë ˆì„ ì „ì†¡)</h2>

  <div class="row">
    <div>
      <video id="preview" autoplay playsinline muted></video>
      <canvas id="stage" width="640" height="480" style="display:none;"></canvas>
    </div>
    <div>
      <div>
        <label>ì¹´ë©”ë¼ ì„ íƒ</label>
        <select id="cameraSelect"></select>
        <span class="pill" id="statFps">24 fps</span>
      </div>
      <div>
        <label>JPEG í’ˆì§ˆ: <span id="qLabel">0.7</span></label>
        <input id="qRange" type="range" min="0.4" max="0.95" step="0.05" value="0.7" />
      </div>
      <div style="margin-top:8px;">
        <button id="btnStart">â–¶ ì‹œì‘</button>
        <button id="btnStop" disabled>â–  ì •ì§€</button>
      </div>
      <div style="margin-top:8px;">
        <small>ì„¸ì…˜ID: <code id="sid"></code> Â· ì „ì†¡ í”„ë ˆì„: <code id="sent">0</code></small>
      </div>
      <div style="margin-top:8px;">
        <small>640Ã—480, ëª©í‘œ 24fps Â· ì „ë©´ ì¹´ë©”ë¼ ìš°ì„ </small>
      </div>
    </div>
  </div>

  <div id="log"></div>

  <!-- Socket.IO ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
  <script>
    // Socket.IO ì—°ê²° ë° ìƒíƒœ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
    const socket = io();
    
    // ì‚¬ìš©ì ì •ë³´
    let currentUser = null;
    let currentSession = null;
    let connectionAttempts = 0;
    
    function log(message) {
        console.log(message);
        const logDiv = document.getElementById('log');
        if (logDiv) {
            logDiv.textContent = (new Date().toLocaleTimeString()) + ' ' + message + '\n' + logDiv.textContent;
            if (logDiv.textContent.length > 5000) {
                logDiv.textContent = logDiv.textContent.substring(0, 5000);
            }
        }
    }
    
    function attemptUserLogin() {
        connectionAttempts++;
        log(`ğŸ”„ ë¡œê·¸ì¸ ì‹œë„ ${connectionAttempts}íšŒ...`);
        
        // ì„¸ì…˜ ì •ë³´ë¥¼ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
        fetch('/api/sessions')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('ğŸ“‹ ì„¸ì…˜ ë°ì´í„°:', data);
                
                if (data.sessions && data.sessions.length > 0) {
                    // class5_3 ì‚¬ìš©ì ìš°ì„  ì°¾ê¸°
                    let userSession = data.sessions.find(s => s.username === 'class5_3');
                    
                    // class5_3ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ í™œì„± ì‚¬ìš©ì ì‚¬ìš©
                    if (!userSession) {
                        userSession = data.sessions[0];
                        log(`âš ï¸ class5_3 ì—†ìŒ, ${userSession.username} ì‚¬ìš©`);
                    }
                    
                    currentUser = userSession.username;
                    currentSession = userSession.session_token;
                    
                    log(`ğŸ‘¤ ì‚¬ìš©ì í™•ì¸: ${currentUser}`);
                    
                    // Socket.IOì— ì‚¬ìš©ì ë¡œê·¸ì¸ ì•Œë¦¼
                    const loginData = {
                        username: currentUser,
                        session_token: currentSession
                    };
                    
                    console.log('ğŸ“¤ ë¡œê·¸ì¸ ë°ì´í„° ì „ì†¡:', loginData);
                    socket.emit('user_login', loginData);
                } else {
                    log('âŒ í™œì„± ì„¸ì…˜ ì—†ìŒ');
                    if (connectionAttempts < 3) {
                        setTimeout(attemptUserLogin, 2000);
                    }
                }
            })
            .catch(error => {
                console.error('âŒ ì„¸ì…˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                log(`âŒ ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                
                if (connectionAttempts < 3) {
                    setTimeout(attemptUserLogin, 2000);
                }
            });
    }
    
    socket.on('connect', function() {
        console.log('âœ… Socket.IO ì—°ê²°ë¨, SID:', socket.id);
        log('ğŸ”— ì„œë²„ ì—°ê²° ì™„ë£Œ');
        connectionAttempts = 0;
        
        // ì—°ê²° í›„ ì ì‹œ ëŒ€ê¸° í›„ ë¡œê·¸ì¸ ì‹œë„
        setTimeout(attemptUserLogin, 500);
    });
    
    socket.on('disconnect', function() {
        console.log('âŒ Socket.IO ì—°ê²° í•´ì œ');
        log('ğŸ”Œ ì„œë²„ ì—°ê²° í•´ì œ');
        currentUser = null;
        currentSession = null;
    });
    
    socket.on('connection_status', function(data) {
        console.log('ğŸ“¡ ì—°ê²° ìƒíƒœ:', data);
        log(`ğŸ“¡ ${data.message}`);
        
        if (data.username) {
            log(`ğŸ‘¤ ë¡œê·¸ì¸: ${data.username} (${data.session_token})`);
            if (data.room) {
                log(`ğŸ  ë£¸: ${data.room}`);
            }
            currentUser = data.username;
        }
    });
    
    socket.on('state_update', function(data) {
        console.log('ğŸ“Š ìƒíƒœ ì—…ë°ì´íŠ¸:', data);
        
        // í˜„ì¬ ì‚¬ìš©ìì˜ ìƒíƒœ ì—…ë°ì´íŠ¸ì¸ì§€ í™•ì¸
        if (currentUser && data.username === currentUser) {
            log(`ğŸ“Š ë‚´ ìƒíƒœ: ${data.stage} (${data.level_code})`);
            updateStateDisplay(data.stage, data.level_code);
        } else if (!currentUser) {
            // ì‚¬ìš©ìê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ëª¨ë“  ìƒíƒœ í‘œì‹œ
            log(`ğŸ“Š ìƒíƒœ: ${data.username} -> ${data.stage} (${data.level_code})`);
            updateStateDisplay(data.stage, data.level_code);
        } else {
            // ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ìƒíƒœëŠ” ê°„ë‹¨íˆ ë¡œê·¸ë§Œ
            log(`ğŸ“Š ${data.username}: ${data.stage}`);
        }
    });
    
    socket.on('error', function(data) {
        console.error('âŒ Socket.IO ì˜¤ë¥˜:', data);
        log(`âŒ ì˜¤ë¥˜: ${data.message}`);
        
        // ë¡œê·¸ì¸ ê´€ë ¨ ì˜¤ë¥˜ë©´ ì¬ì‹œë„
        if (data.message.includes('session') || data.message.includes('login')) {
            if (connectionAttempts < 3) {
                setTimeout(attemptUserLogin, 3000);
            }
        }
    });
    
    function updateStateDisplay(stage, level_code) {
        // ìƒíƒœì— ë”°ë¥¸ í™”ë©´ ìƒ‰ìƒ ë³€ê²½
        const body = document.body;
        body.classList.remove('normal', 'warning', 'danger', 'critical');
        
        if (level_code <= 40) {
            body.classList.add('normal');
        } else if (level_code <= 60) {
            body.classList.add('warning');
        } else if (level_code <= 80) {
            body.classList.add('danger');
        } else {
            body.classList.add('critical');
        }
        
        // ì œëª©ë„ ì—…ë°ì´íŠ¸
        document.title = `[${stage}] JPEG Frame Uploader`;
        
        // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        const stateDisplay = document.getElementById('currentState');
        if (stateDisplay) {
            stateDisplay.textContent = `${stage} (${level_code})`;
        }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ìƒíƒœ í‘œì‹œ ìš”ì†Œ ì¶”ê°€
    document.addEventListener('DOMContentLoaded', function() {
        const controls = document.querySelector('.row > div:nth-child(2)');
        if (controls) {
            const stateDiv = document.createElement('div');
            stateDiv.style.marginTop = '8px';
            stateDiv.innerHTML = '<small>í˜„ì¬ ìƒíƒœ: <code id="currentState">ì—°ê²° ëŒ€ê¸°ì¤‘...</code></small>';
            controls.appendChild(stateDiv);
        }
    });
  </script>
  <style>
    /* ìƒíƒœë³„ ë°°ê²½ìƒ‰ */
    body.normal { background-color: #f0f8f0; }
    body.warning { background-color: #fff8e1; }
    body.danger { background-color: #ffebee; }
    body.critical { background-color: #ffcdd2; animation: blink 1s infinite; }
    
    @keyframes blink {
        0%, 50% { background-color: #ffcdd2; }
        51%, 100% { background-color: #f44336; }
    }
  </style>
  <script src="/static/js/stream_service.js"></script>
</body>
</html>
